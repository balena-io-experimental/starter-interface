"use strict";(self.webpackChunkbalena_labs_docs=self.webpackChunkbalena_labs_docs||[]).push([[660],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),c=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),m=a,f=d["".concat(l,".").concat(m)]||d[m]||p[m]||i;return n?r.createElement(f,o(o({ref:t},u),{},{components:n})):r.createElement(f,o({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},3289:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});var r=n(7462),a=(n(7294),n(3905));const i={},o=void 0,s={unversionedId:"Built-in components/Cache Timeouts and Queuing",id:"Built-in components/Cache Timeouts and Queuing",title:"Cache Timeouts and Queuing",description:"In the ExpressJS backend there is middleware available for caching and queueing requests. This prevents unnecessary calls to the Supervisor or SDK and also prevents multiple requests to the same endpoint from being made at the same time to speed up responses and reduce traffic. It follows a number of general rules:",source:"@site/docs/Built-in components/Cache Timeouts and Queuing.md",sourceDirName:"Built-in components",slug:"/Built-in components/Cache Timeouts and Queuing",permalink:"/starter-interface/Built-in components/Cache Timeouts and Queuing",draft:!1,editUrl:"https://github.com/balena-labs-research/starter-interface/edit/main/docs/Built-in components/Cache Timeouts and Queuing.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Backend Endpoints",permalink:"/starter-interface/Built-in components/Backend Endpoints"},next:{title:"CloudLink Check",permalink:"/starter-interface/Built-in components/CloudLink Check"}},l={},c=[{value:"Examples",id:"examples",level:2}],u={toc:c};function p(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,r.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"In the ExpressJS backend there is middleware available for caching and queueing requests. This prevents unnecessary calls to the Supervisor or SDK and also prevents multiple requests to the same endpoint from being made at the same time to speed up responses and reduce traffic. It follows a number of general rules:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Each endpoint has its own queue. For example, a request to ",(0,a.kt)("inlineCode",{parentName:"li"},"/ping")," will not wait for a request from ",(0,a.kt)("inlineCode",{parentName:"li"},"/v1/device"),", it will only wait for other requests to finish on ",(0,a.kt)("inlineCode",{parentName:"li"},"/ping"),"."),(0,a.kt)("li",{parentName:"ol"},"When two requests are made on the same endpoint - and the middleware is applied to the endpoints - it will wait for the first response to return before the second is executed."),(0,a.kt)("li",{parentName:"ol"},"If caching is enabled on the endpoint and the last request was returned in less than the passed timeout integer it will return the cached content on the second request, instead of making a new request."),(0,a.kt)("li",{parentName:"ol"},"Caching can only be enabled for endpoints with the ",(0,a.kt)("inlineCode",{parentName:"li"},"type: 'GET'")," parameter passed or those requested as an Axios ",(0,a.kt)("inlineCode",{parentName:"li"},"GET")," request. Caching ",(0,a.kt)("inlineCode",{parentName:"li"},"POST")," or ",(0,a.kt)("inlineCode",{parentName:"li"},"PATCH")," requests would defeat the object of requesting a change on the device if it was cached.")),(0,a.kt)("p",null,"To use the middleware, include it in your route as follows:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"router.post('/v1/filemanager/delete', queueCache, (async (req: Request, res: Response) => {\n...\n}) as RequestHandler)\n")),(0,a.kt)("p",null,"Configure the endpoints as follows, which will return the response from the cache if the last response was returned in less than the number of milliseconds specified in ",(0,a.kt)("inlineCode",{parentName:"p"},"cacheTimeout"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"device_name() {\n  return expressApi.post(apiPath + supervisorPath, {\n    type: 'GET',\n    path: 'v2/device/name',\n    params: false,\n    cacheTimeout: 5000\n  })\n},\n")),(0,a.kt)("h2",{id:"examples"},"Examples"),(0,a.kt)("p",null,"Using default cache expiry set in ",(0,a.kt)("inlineCode",{parentName:"p"},"expressjs/src/index.js"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"cacheTimeout: 0;\n")),(0,a.kt)("p",null,"Return previously fetched content if less than 2 seconds old:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-typescript"},"cacheTimeout: 2000;\n")))}p.isMDXComponent=!0}}]);